<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pendaftaran Kehadiran | Masjid UMMI</title>

  <link rel="stylesheet" href="style.css" />
  <script src="script.js" defer></script>
</head>
<body>

<!-- ==================== NAVIGATION ==================== -->
<nav>
  <div class="nav-inner">
    <a href="index.html" class="nav-logo">Masjid UMMI</a>
    <div class="hamburger" onclick="toggleMenu()">☰</div>
    <div class="nav-links" id="nav">
      <a href="index.html#about">Tentang</a>
      <a href="index.html#support">Dukung</a>
      <a href="index.html#location">Lokasi</a>
      <a href="index.html#follow">Ikuti</a>
      <a href="contact.html">Hubungi Kami</a>
    </div>
  </div>
</nav>

<!-- ==================== PAGE HEADER ==================== -->
<section class="donation-instructions fade">
  <h2 class="section-title">Kajian Bersama Ust. Handy Bonny</h2>
  <p class="donation-subtitle">
    Mohon isi data kehadiran untuk membantu panitia mempersiapkan acara. <strong>Batas waktu pendaftaran hingga 7 Maret 2026 pukul 12:00 AM JST.</strong>
  </p>

  <form class="donation-form" id="registrationForm">

    <!-- Nama -->
    <div class="form-group">
      <label>Nama</label>
      <input type="text" name="nama" placeholder="Nama lengkap" required />
    </div>
    <div class="form-group">
      <label>Alamat</label>
      <input type="text" name="alamat" placeholder="Alamat lengkap" required />
    </div>

    <div class="form-group">
      <label>No WhatsApp</label>
      <input type="tel" id="wa" name="phone" placeholder="contoh: 6281234567890" required>
      <small style="display:block; color:#555; font-size:0.85em; margin-top:4px;">
      ✔ Sertakan kode negara (misal: 62 untuk Indonesia, 81 untuk Jepang)<br>
      ✔ Hanya angka, jangan pakai +, spasi, atau tanda strip (-)<br>
      </small>
      </div>

    <!-- ==================== JUMLAH HADIR ==================== -->
<div class="form-group">
  <label>Jumlah yang Hadir</label>

  <!-- Dewasa -->
  <div style="margin-bottom:1rem;">
    <label style="font-weight:500;">Dewasa</label>
    <div style="display:flex; gap:1rem;">
      
      <div>
        <label style="font-size:0.8rem;">L</label>
        <select name="dewasa_l" required>
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>

      <div>
        <label style="font-size:0.8rem;">P</label>
        <select name="dewasa_p" required>
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Anak -->
  <div>
    <label style="font-weight:500;">Anak</label>
    <div style="display:flex; gap:1rem;">
      
      <div>
        <label style="font-size:0.8rem;">L</label>
        <select id="anakL" name="anak_l">
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>

      <div>
        <label style="font-size:0.8rem;">P</label>
        <select id="anakP" name="anak_p">
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>

    </div>
  </div>
</div>

<!-- ==================== USIA ANAK ==================== -->
<div class="form-group" id="usiaAnakGroup" style="display:none;">
  <label>Usia Anak</label>

  <div id="usiaContainer" style="display:flex; flex-direction:column; gap:10px;"></div>

  <input type="hidden" name="usia_anak" id="usiaAnakGabungan">
</div>

<div class="form-group">
  <label>Transportasi</label>

  <div style="display:flex; gap:1rem;">
    <label>
      <input type="radio" name="transportasi" value="Umum" required>
      Umum
    </label>

    <label>
      <input type="radio" name="transportasi" value="Pribadi" required>
      Pribadi
    </label>
  </div>
</div>

    <!-- Catatan -->
    <div class="form-group">
      <label>Catatan (Opsional)</label>
      <textarea name="catatan" rows="4" placeholder="Contoh: alergi, kebutuhan khusus, dll"></textarea>
    </div>

    <input type="hidden" name="id" id="registrationId" />
    <p id="totalOrang" style="margin-top:10px; font-weight:bold;"></p>
    <button type="submit" class="donation-btn">
      Kirim Pendaftaran
    </button>

  </form>
</section>

<!-- ==================== FOOTER ==================== -->
<footer>
  <p>
    <br><br>
    “Whoever builds a masjid for Allah,
    Allah will build for him a house in Paradise.”
    <br>— Prophet Muhammad ﷺ
    <br><br>
    © UMMI Masjid · ummi.jp · info@ummi.jp
  </p>
</footer>

<!-- ==================== SCRIPT ==================== -->
<script>
const form = document.getElementById("registrationForm");
const anakL = document.getElementById("anakL");
const anakP = document.getElementById("anakP");
const usiaGroup = document.getElementById("usiaAnakGroup");
const usiaContainer = document.getElementById("usiaContainer");
const usiaHidden = document.getElementById("usiaAnakGabungan");

/* =========================
   GENERATE INPUT USIA ANAK
========================= */
function updateUsiaInputs() {
  const jumlah = (parseInt(anakL.value) || 0) + (parseInt(anakP.value) || 0);

  usiaContainer.innerHTML = "";

  if (jumlah > 0) {
    usiaGroup.style.display = "block";

    for (let i = 0; i < jumlah; i++) {
      const input = document.createElement("input");
      input.type = "number";
      input.min = "0";
      input.placeholder = `Usia Anak ${i + 1}`;
      input.classList.add("usia-anak");
      input.required = true;

      usiaContainer.appendChild(input);
    }
  } else {
    usiaGroup.style.display = "none";
  }

  updateTotal();
}

/* =========================
   HITUNG TOTAL
========================= */
function updateTotal() {
  const total =
    parseInt(anakL.value || "0") +
    parseInt(anakP.value || "0") +
    parseInt(document.querySelector('[name="dewasa_l"]').value || "0") +
    parseInt(document.querySelector('[name="dewasa_p"]').value || "0");

  document.getElementById("totalOrang").textContent =
    total > 0 ? `Total hadir: ${total} orang` : "";
}

/* =========================
   EVENT
========================= */
anakL.addEventListener("change", updateUsiaInputs);
anakP.addEventListener("change", updateUsiaInputs);
document.querySelector('[name="dewasa_l"]').addEventListener("change", updateTotal);
document.querySelector('[name="dewasa_p"]').addEventListener("change", updateTotal);

/* =========================
   SUBMIT
========================= */
form.addEventListener("submit", async e => {
  e.preventDefault();

  const registrationId = Date.now().toString();
  document.getElementById("registrationId").value = registrationId;

  const dewasaL = parseInt(form.querySelector('[name="dewasa_l"]').value || "0");
  const dewasaP = parseInt(form.querySelector('[name="dewasa_p"]').value || "0");
  const total =
    dewasaL +
    dewasaP +
    parseInt(anakL.value || "0") +
    parseInt(anakP.value || "0");

  if (total === 0) {
    alert("Minimal 1 orang harus hadir");
    return;
  }

  // usia anak
  const inputs = document.querySelectorAll(".usia-anak");
  let usiaList = [];

  inputs.forEach(input => {
    if (input.value !== "") {
      usiaList.push(input.value.trim());
    }
  });

  if (inputs.length > 0 && usiaList.length < inputs.length) {
    alert("Harap isi semua usia anak");
    return;
  }

  for (let usia of usiaList) {
    if (isNaN(usia) || usia < 0) {
      alert("Usia anak tidak valid");
      return;
    }
  }

  usiaHidden.value = usiaList.join(",");

  const btn = form.querySelector("button");
  btn.disabled = true;
  btn.textContent = "Mengirim...";

  try {
    const formData = new FormData(form);
    const payload = {};

    for (let [k, v] of formData.entries()) {
      payload[k] = v;
    }

    payload.id = registrationId;
    payload.timestamp = new Date().toISOString();
    payload.total = total;

    const res = await fetch("https://script.google.com/macros/s/AKfycbwSqprQxi5nE9qd9tZxBNNHzSg0S0KzA_Kw8AbEWjuKMJrkGsvtSQ2HNjkbjTViul9lLg/exec", {
      method: "POST",
      body: JSON.stringify(payload),
      headers: { "Content-Type": "text/plain;charset=utf-8" },
    });

    const result = await res.json();
    if (result.status !== "success") throw new Error(result.message);

    /* =========================
       WHATSAPP
    ========================= */
    let wa = payload.wa;

    // normalisasi nomor
    wa = wa.replace(/[^0-9]/g, "");
    if (wa.startsWith("08")) {
      wa = "62" + wa.substring(1);
    }

    const qrLink = `https://ummi.jp/terimakasih2.html?id=${registrationId}`;

    const message =
`Assalamu'alaikum,

Pendaftaran Kajian berhasil.

Nama: ${payload.nama}
Total Hadir: ${total} orang

Silakan buka QR:
${qrLink}

Tunjukkan QR saat check-in.

Jazakumullahu khairan.`;

    const waUrl = `https://wa.me/${wa}?text=${encodeURIComponent(message)}`;

    // buka WhatsApp
    window.location.href = waUrl;

  } catch (err) {
    alert("Gagal mengirim: " + err.message);
  } finally {
    btn.disabled = false;
    btn.textContent = "Kirim Pendaftaran";
  }
});

/* =========================
   INIT
========================= */
updateTotal();
</script>

</body>
</html>
